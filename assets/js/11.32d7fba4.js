(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{382:function(s,n,e){s.exports=e.p+"assets/img/perm07.14e73cd6.jpg"},483:function(s,n,e){s.exports=e.p+"assets/img/permission01.5d4b302f.jpg"},484:function(s,n,e){s.exports=e.p+"assets/img/permission02.ab5f80e3.jpg"},485:function(s,n,e){s.exports=e.p+"assets/img/perm03.7e7a1652.jpg"},486:function(s,n,e){s.exports=e.p+"assets/img/perm04.9bbd792a.jpg"},487:function(s,n,e){s.exports=e.p+"assets/img/perm05.5b41a8dd.jpg"},488:function(s,n,e){s.exports=e.p+"assets/img/perm06.b40f8d6d.jpg"},529:function(s,n,e){"use strict";e.r(n);var a=e(2),t=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("日常工作中因为老和后台管理系统打交道，所以当然不可避免的会遇到权限控制的场景。这里针对在项目中所做的权限控制方案进行一个记录")]),s._v(" "),n("h2",{attrs:{id:"权限模型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#权限模型"}},[s._v("#")]),s._v(" 权限模型")]),s._v(" "),n("p",[s._v("项目中用到的权限模型是 RBAC权限模型，RBAC权限模型有三个基础的组成部分，分别是：用户、角色和权限：")]),s._v(" "),n("ul",[n("li",[s._v("用户：可以是单个用户，也可以是用户组")]),s._v(" "),n("li",[s._v("角色：可以定义为单个角色，也可以将同类型的角色做成角色集，上下级的角色定义为岗位")]),s._v(" "),n("li",[s._v("权限：可以分为两大类：功能权限和数据权限。功能权限是指菜单（页面），按钮（api）等这类权限。数据权限是指对数据访问范围的区分，如根据国家区分数据的访问范围。")])]),s._v(" "),n("p",[s._v("RBAC三个部分的关系图如下：\n"),n("img",{attrs:{src:e(483),alt:"npm img"}})]),s._v(" "),n("p",[s._v("结合了RBAC的想法，用户、角色、权限中的权限我们在实际开发中可以拆分为 功能权限和数据权限。")]),s._v(" "),n("ul",[n("li",[s._v("功能权限：指的是页面，菜单栏，按钮这类能够被操作的权限")]),s._v(" "),n("li",[s._v("数据权限：指的是数据的访问范围。")])]),s._v(" "),n("p",[s._v("所以结合RBAC和权限设计，一个简单的权限模型设计如下：")]),s._v(" "),n("p",[n("img",{attrs:{src:e(484),alt:"npm img"}})]),s._v(" "),n("h2",{attrs:{id:"实现的页面如下"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实现的页面如下"}},[s._v("#")]),s._v(" 实现的页面如下")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("资源管理页面\n"),n("img",{attrs:{src:e(485),alt:"npm img"}}),s._v("\n该页面就是用来配置功能的功能权限 页面、菜单、按钮（API）访问，这里称为资源。")]),s._v(" "),n("p",[s._v("对于页面和菜单增改操作，点击按钮激活弹窗进行编辑调用接口将设置后的数据保存到数据库，删除则直接调用接口。\n"),n("img",{attrs:{src:e(486),alt:"npm img"}})]),s._v(" "),n("p",[s._v("资源的字段设计如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("resource_id: 资源id\nresource_name: 资源名称\nresource_type: 资源类型（M：目录 C：菜单 F：按钮）\npath: 前端表示路由地址，后端表示url\ncomponent 前端组件路径\nperms：权限标识\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("功能权限配置页")])])]),s._v(" "),n("p",[s._v("一个功能权限可以对应多个资源，功能权限表的设计：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("function_id: 功能权限id\nresource_ids: 资源id组\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("通关resource_ids 功能权限可以和资源关联起来。")]),s._v(" "),n("p",[s._v("功能权限页面如下：\n"),n("img",{attrs:{src:e(487),alt:"npm img"}})]),s._v(" "),n("p",[s._v("点击修改按钮就可以重新配置功能权限，此时得到的功能权限列表为按钮和菜单相关联的权限树\n"),n("img",{attrs:{src:e(488),alt:"npm img"}})]),s._v(" "),n("ol",{attrs:{start:"3"}},[n("li",[n("p",[s._v("角色管理页面")]),s._v(" "),n("p",[s._v("而一个角色可以对应多个权限功能，角色管理的表设计如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("role_id: 角色id\nrole_name: 角色名称\nfunction_ids: 关联的权限列表\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("角色管理列表页面如下：\n"),n("img",{attrs:{src:e(382),alt:"npm img"}})]),s._v(" "),n("p",[s._v("角色修改和新增也是修改和功能权限的关联性\n"),n("img",{attrs:{src:e(382),alt:"npm img"}})]),s._v(" "),n("p",[s._v("再此，角色和资源都有了。我们就可以和用户关联起来 一个用户可以对应多个角色。那么改用户的权限就是所有角色拥有的资源集合。")]),s._v(" "),n("h2",{attrs:{id:"前端权限控制的实现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前端权限控制的实现"}},[s._v("#")]),s._v(" 前端权限控制的实现")]),s._v(" "),n("p",[s._v("前端权限控制有以下几个步骤：")]),s._v(" "),n("ol",[n("li",[s._v("登录后请求接口获取用户信息，里面就包括该用户所拥有的资源列表有 M（目录）C（菜单）和F（按钮）还包括一个权限资源id集合 permissions")]),s._v(" "),n("li",[s._v("通过 对资源树的遍历可以拿到 permissions 权限标识集合，用户组件级权限控制。去除资源树的F（按钮）我们可以得到侧边栏的菜单数据menuList。对菜单进行打平我们可以得到一个routes")]),s._v(" "),n("li",[s._v("通过 router.addRoute 方法将路由表加入到 routes中")]),s._v(" "),n("li",[s._v("我们有 permissions 就可以通过指令的形式进行组件级的权限控制")]),s._v(" "),n("li",[s._v("根据 menuList 我们可以生成侧边栏")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('\n// 路由守卫逻辑\nrouter.beforeEach(async (to, from, next) => {\n   if (getToken()) {\n     // 登陆后，直接放行\n     // 设置当前用户的信息，包括姓名，头像，角色，权限信息\n     await setUserInfoAction();\n     \n     // 设置当前用户的左侧菜单\n     await generateMenusAction(userState.permissions);\n     // 根据菜单栏生成路由\n     generateRoutes(usePermissionState.rolesRoutes);\n     // 解决使用动态路由地址直接访问，或者刷新页面导致无法找到路由的问题 No match found\n     if (to.path == \'/404\' && to.redirectedFrom != undefined) {\n         if (router.getRoutes().find(item => item.path === to.redirectedFrom?.path)) {\n             next({ path: to.redirectedFrom?.fullPath, replace: true })\n         } else {\n             next(\'/notFound\')\n         }\n     } else {\n         next()\n     }\n   } else {\n       // 登陆后token过期,路由地址是白名单直接放行\n       if (whiteList.includes(to.path)) {\n           next();\n           // next({ path: to.path, query: { redirect: to.fullPath } });\n       } else {\n           // 登陆后token过期，跳转到首页，query 放入当前路由的path\n           if (to.path == \'/404\' && to.redirectedFrom != undefined) {\n               next({ path: "/login", query: { redirect: to.redirectedFrom?.fullPath } });\n           } else {\n               next({ path: "/login", query: { redirect: to.fullPath } });\n           }\n       }\n   }\n});\nfunction generateRoutes(menusPath: Resource[]) {\nmenusPath.length > 0 && menusPath.forEach(menu => {\n   router.addRoute("index", {\n       path: `/${menu.path}`,\n       name: menu.path,\n       // component: () => import(`@/views/${menu.component}.vue`)\n       component:\n           //需要用vite规定的导入方式导入,否则打包后部署到服务器报错找不到动态导入的文件,\n           //对应上方的const modules = import.meta.glob("../views/**/**.vue")\n           //使用/* @vite-ignore */则不会在开发是报错\n           modules[/* @vite-ignore */`../views/${menu.component}.vue`],\n   })\n})\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br")])]),n("p",[s._v("组件级权限控制：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("<template>\n   \x3c!-- Admin can see this --\x3e\n   <el-tag v-permission=\"['admin']\">admin</el-tag>\n\n   \x3c!-- Editor can see this --\x3e\n   <el-tag v-permission=\"['editor']\">editor</el-tag>\n\n   \x3c!-- Editor can see this --\x3e\n   <el-tag v-permission=\"['admin','editor']\">Both admin or editor can see this</el-tag>\n </template>\n\n <script>\n   // 当然你也可以为了方便使用，将它注册到全局\n   import permission from '@/directive/permission/index.js' // 权限判断指令\n   export default{\n     directives: { permission }\n   }\n <\/script>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("v-permission指令的实现")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("    unction checkPermission(el, binding) {\n    const { value } = binding\n    const roles = store.getters && store.getters.roles\n\n    if (value && value instanceof Array) {\n      if (value.length > 0) {\n        const permissionRoles = value\n\n        const hasPermission = roles.some(role => {\n          return permissionRoles.includes(role)\n        })\n\n        if (!hasPermission) {\n          el.parentNode && el.parentNode.removeChild(el)\n        }\n      }\n    } else {\n      throw new Error(`need roles! Like v-permission=\"['admin','editor']\"`)\n    }\n  }\n\n  export default {\n    inserted(el, binding) {\n      checkPermission(el, binding)\n    },\n    update(el, binding) {\n      checkPermission(el, binding)\n    }\n  }\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])])])])])}),[],!1,null,null,null);n.default=t.exports}}]);